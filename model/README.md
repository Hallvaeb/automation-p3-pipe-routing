This is where the logic happens.